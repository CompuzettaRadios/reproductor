<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 Music Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .header p {
            color: #64748b;
            font-size: 14px;
        }

        .main-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            background: #fafbfc;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 30px;
            transition: all 0.2s ease;
            background: white;
        }

        .upload-area.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 4px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .stats {
            padding: 20px 40px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            text-align: center;
            min-width: 80px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .config-section {
            padding: 30px 40px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            background: #fafbfc;
        }

        .config-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .files-section {
            padding: 20px 40px;
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .genre-group {
            margin-bottom: 30px;
        }

        .genre-header {
            background: #f1f5f9;
            padding: 12px 16px;
            border-radius: 6px 6px 0 0;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .genre-title {
            font-weight: 600;
            color: #334155;
            text-transform: capitalize;
        }

        .file-count {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .file-list {
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 6px 6px;
        }

        .file-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 16px;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            min-width: 0;
        }

        .file-title {
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .file-details {
            font-size: 12px;
            color: #64748b;
        }

        .file-artist {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-artist input {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            min-width: 120px;
        }

        .actions-section {
            padding: 30px 40px;
            background: #f8fafc;
            text-align: center;
        }

        .message {
            margin: 20px 0;
            padding: 12px 16px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        .message.success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .message.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .message.info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
        }

        .code-output {
            margin-top: 30px;
            display: none;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .hidden {
            display: none !important;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .text-sm {
            font-size: 12px;
        }

        .text-muted {
            color: #64748b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .upload-section,
            .config-section,
            .files-section,
            .actions-section {
                padding: 20px;
            }

            .stats {
                padding: 15px 20px;
                gap: 15px;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .file-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .file-artist {
                justify-content: space-between;
            }
        }

        .bulk-actions {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .bulk-actions h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
        }

        .bulk-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 8px;
        }

        .artist-suggestions {
            margin-top: 8px;
        }

        .suggestion-chip {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-chip:hover {
            background: #c7d2fe;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Music Admin</h1>
            <p>Administrador minimalista de archivos de música</p>
        </div>

        <div class="main-panel">
            <!-- Upload Section -->
            <div class="upload-section">
                <div id="uploadArea" class="upload-area">
                    <div class="upload-icon">📁</div>
                    <h3>Seleccionar Archivos MP3</h3>
                    <p class="text-muted mb-20">Arrastra archivos aquí o haz clic para seleccionar</p>
                    <button id="selectBtn" class="btn btn-primary">Seleccionar Archivos</button>
                    <button id="clearBtn" class="btn btn-danger">Limpiar</button>
                    <input type="file" id="fileInput" multiple accept=".mp3,.MP3" style="display: none;">
                </div>
            </div>

            <!-- Stats -->
            <div id="statsSection" class="stats hidden">
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="corosCount">0</div>
                    <div class="stat-label">Coros</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="himnosCount">0</div>
                    <div class="stat-label">Himnos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="testimonialesCount">0</div>
                    <div class="stat-label">Testimoniales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="especialesCount">0</div>
                    <div class="stat-label">Especiales</div>
                </div>
            </div>

            <!-- Configuration -->
            <div id="configSection" class="config-section hidden">
                <h2 class="section-title mb-10">⚙️ Configuración</h2>
                <p class="text-muted mb-20">Personaliza los géneros y artistas por defecto</p>
                
                <div class="config-grid">
                    <div class="config-card">
                        <h3>Géneros Disponibles</h3>
                        <div class="input-group">
                            <label>Coros</label>
                            <input type="text" id="corosFolder" value="coros" placeholder="Nombre de carpeta">
                        </div>
                        <div class="input-group">
                            <label>Himnos</label>
                            <input type="text" id="himnosFolder" value="himnos" placeholder="Nombre de carpeta">
                        </div>
                        <div class="input-group">
                            <label>Testimoniales</label>
                            <input type="text" id="testimonialesFolder" value="testimoniales" placeholder="Nombre de carpeta">
                        </div>
                        <div class="input-group">
                            <label>Especiales</label>
                            <input type="text" id="especialesFolder" value="especiales" placeholder="Nombre de carpeta">
                        </div>
                    </div>

                    <div class="config-card">
                        <h3>Artistas por Defecto</h3>
                        <div class="input-group">
                            <label>Coros</label>
                            <input type="text" id="corosArtist" value="Congregación" placeholder="Artista por defecto">
                        </div>
                        <div class="input-group">
                            <label>Himnos</label>
                            <input type="text" id="himnosArtist" value="Himno Tradicional" placeholder="Artista por defecto">
                        </div>
                        <div class="input-group">
                            <label>Testimoniales</label>
                            <input type="text" id="testimonialesArtist" value="Testimonio" placeholder="Artista por defecto">
                        </div>
                        <div class="input-group">
                            <label>Especiales</label>
                            <input type="text" id="especialesArtist" value="Alabanza Especial" placeholder="Artista por defecto">
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <h4>📝 Edición en Masa</h4>
                    <div class="bulk-row">
                        <div class="input-group">
                            <label>Cambiar artista por género</label>
                            <input type="text" id="bulkArtistName" placeholder="Ej: Hno. Carlos">
                        </div>
                        <div class="input-group">
                            <label>Género</label>
                            <select id="bulkGenre">
                                <option value="">Seleccionar</option>
                                <option value="coros">Coros</option>
                                <option value="himnos">Himnos</option>
                                <option value="testimoniales">Testimoniales</option>
                                <option value="especiales">Especiales</option>
                            </select>
                        </div>
                        <button id="applyBulkBtn" class="btn btn-secondary btn-sm">Aplicar</button>
                    </div>
                    <div class="artist-suggestions">
                        <strong class="text-sm">Sugerencias:</strong>
                        <span class="suggestion-chip" onclick="setBulkArtist('Hno. Carlos')">Hno. Carlos</span>
                        <span class="suggestion-chip" onclick="setBulkArtist('Hna. María')">Hna. María</span>
                        <span class="suggestion-chip" onclick="setBulkArtist('Coro Juvenil')">Coro Juvenil</span>
                        <span class="suggestion-chip" onclick="setBulkArtist('Ministerio Musical')">Ministerio Musical</span>
                        <span class="suggestion-chip" onclick="setBulkArtist('Congregación')">Congregación</span>
                    </div>
                </div>
            </div>

            <!-- Files List -->
            <div id="filesSection" class="files-section hidden">
                <div class="section-header">
                    <h2 class="section-title">📂 Archivos de Música</h2>
                </div>
                <div id="filesList"></div>
            </div>

            <!-- Actions -->
            <div id="actionsSection" class="actions-section hidden">
                <button id="generateBtn" class="btn btn-primary">📄 Generar Código</button>
                <button id="downloadBtn" class="btn btn-secondary">💾 Descargar JSON</button>
                <button id="copyListBtn" class="btn btn-secondary">📋 Copiar Lista</button>
            </div>

            <div id="messageArea"></div>

            <!-- Code Output -->
            <div id="codeOutput" class="code-output">
                <h3>📝 Código Generado</h3>
                <p class="text-muted mb-20">Copia este código y reemplaza el método loadSongs() en tu index.html:</p>
                <div id="codeBlock" class="code-block"></div>
                <div style="text-align: center; margin-top: 16px;">
                    <button id="copyCodeBtn" class="btn btn-primary">📋 Copiar Código</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MusicAdminV2 {
            constructor() {
                this.files = [];
                this.config = {
                    genres: {
                        coros: { folder: 'coros', artist: 'Congregación' },
                        himnos: { folder: 'himnos', artist: 'Himno Tradicional' },
                        testimoniales: { folder: 'testimoniales', artist: 'Testimonio' },
                        especiales: { folder: 'especiales', artist: 'Alabanza Especial' }
                    }
                };
                
                this.init();
            }

            init() {
                this.bindElements();
                this.setupEventListeners();
                this.loadConfig();
            }

            bindElements() {
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.selectBtn = document.getElementById('selectBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.messageArea = document.getElementById('messageArea');
                
                // Sections
                this.statsSection = document.getElementById('statsSection');
                this.configSection = document.getElementById('configSection');
                this.filesSection = document.getElementById('filesSection');
                this.actionsSection = document.getElementById('actionsSection');
                this.codeOutput = document.getElementById('codeOutput');
                
                // Config inputs
                this.configInputs = {
                    corosFolder: document.getElementById('corosFolder'),
                    himnosFolder: document.getElementById('himnosFolder'),
                    testimonialesFolder: document.getElementById('testimonialesFolder'),
                    especialesFolder: document.getElementById('especialesFolder'),
                    corosArtist: document.getElementById('corosArtist'),
                    himnosArtist: document.getElementById('himnosArtist'),
                    testimonialesArtist: document.getElementById('testimonialesArtist'),
                    especialesArtist: document.getElementById('especialesArtist')
                };
                
                // Bulk actions
                this.bulkArtistName = document.getElementById('bulkArtistName');
                this.bulkGenre = document.getElementById('bulkGenre');
                this.applyBulkBtn = document.getElementById('applyBulkBtn');
                
                // Stats
                this.statElements = {
                    total: document.getElementById('totalCount'),
                    coros: document.getElementById('corosCount'),
                    himnos: document.getElementById('himnosCount'),
                    testimoniales: document.getElementById('testimonialesCount'),
                    especiales: document.getElementById('especialesCount')
                };
            }

            setupEventListeners() {
                // Upload
                this.selectBtn.addEventListener('click', () => this.fileInput.click());
                this.clearBtn.addEventListener('click', () => this.clearAll());
                this.fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
                
                // Drag & Drop
                this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                // LÍNEA REMOVIDA: this.uploadArea.addEventListener('click', () => this.fileInput.click());
                
                // Config changes
                Object.values(this.configInputs).forEach(input => {
                    input.addEventListener('change', () => this.updateConfig());
                });
                
                // Bulk actions
                this.applyBulkBtn.addEventListener('click', () => this.applyBulkEdit());
                
                // Actions
                document.getElementById('generateBtn').addEventListener('click', () => this.generateCode());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadJSON());
                document.getElementById('copyListBtn').addEventListener('click', () => this.copyList());
                document.getElementById('copyCodeBtn').addEventListener('click', () => this.copyCode());
            }

            loadConfig() {
                // Update config inputs with current values
                Object.keys(this.config.genres).forEach(genre => {
                    if (this.configInputs[genre + 'Folder']) {
                        this.configInputs[genre + 'Folder'].value = this.config.genres[genre].folder;
                    }
                    if (this.configInputs[genre + 'Artist']) {
                        this.configInputs[genre + 'Artist'].value = this.config.genres[genre].artist;
                    }
                });
            }

            updateConfig() {
                Object.keys(this.config.genres).forEach(genre => {
                    if (this.configInputs[genre + 'Folder']) {
                        this.config.genres[genre].folder = this.configInputs[genre + 'Folder'].value;
                    }
                    if (this.configInputs[genre + 'Artist']) {
                        this.config.genres[genre].artist = this.configInputs[genre + 'Artist'].value;
                    }
                });
                this.showMessage('✅ Configuración actualizada', 'success');
            }

            handleFiles(fileList) {
                const mp3Files = Array.from(fileList).filter(file => 
                    file.type === 'audio/mpeg' || 
                    file.name.toLowerCase().endsWith('.mp3')
                );

                if (mp3Files.length === 0) {
                    this.showMessage('⚠️ No se encontraron archivos MP3', 'error');
                    return;
                }

                mp3Files.forEach(file => {
                    if (!this.files.find(f => f.name === file.name && f.size === file.size)) {
                        const genre = this.detectGenre(file.name);
                        this.files.push({
                            id: Date.now() + Math.random(),
                            file: file,
                            name: file.name,
                            title: this.formatTitle(file.name),
                            genre: genre,
                            artist: this.config.genres[genre].artist,
                            size: file.size
                        });
                    }
                });

                this.updateDisplay();
                this.showMessage(`✅ ${mp3Files.length} archivos agregados`, 'success');
            }

            detectGenre(filename) {
                const name = filename.toLowerCase();
                if (name.includes('coro') || name.includes('congregacion')) return 'coros';
                if (name.includes('himno') || name.includes('tradicional')) return 'himnos';
                if (name.includes('testimonio') || name.includes('testifica')) return 'testimoniales';
                if (name.includes('especial') || name.includes('alabanza')) return 'especiales';
                return 'coros'; // default
            }

            formatTitle(filename) {
                return filename
                    .replace(/\.(mp3|MP3)$/, '')
                    .replace(/[-_]/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase())
                    .trim();
            }

            updateDisplay() {
                if (this.files.length === 0) {
                    this.statsSection.classList.add('hidden');
                    this.configSection.classList.add('hidden');
                    this.filesSection.classList.add('hidden');
                    this.actionsSection.classList.add('hidden');
                    return;
                }

                this.statsSection.classList.remove('hidden');
                this.configSection.classList.remove('hidden');
                this.filesSection.classList.remove('hidden');
                this.actionsSection.classList.remove('hidden');
                
                this.updateStats();
                this.renderFiles();
            }

            updateStats() {
                const stats = {
                    total: this.files.length,
                    coros: this.files.filter(f => f.genre === 'coros').length,
                    himnos: this.files.filter(f => f.genre === 'himnos').length,
                    testimoniales: this.files.filter(f => f.genre === 'testimoniales').length,
                    especiales: this.files.filter(f => f.genre === 'especiales').length
                };

                Object.keys(stats).forEach(key => {
                    if (this.statElements[key]) {
                        this.statElements[key].textContent = stats[key];
                    }
                });
            }

            renderFiles() {
                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '';

                Object.keys(this.config.genres).forEach(genre => {
                    const genreFiles = this.files.filter(f => f.genre === genre);
                    
                    if (genreFiles.length > 0) {
                        const genreGroup = document.createElement('div');
                        genreGroup.className = 'genre-group';
                        
                        genreGroup.innerHTML = `
                            <div class="genre-header">
                                <span class="genre-title">📁 ${genre}</span>
                                <span class="file-count">${genreFiles.length}</span>
                            </div>
                            <div class="file-list" id="list-${genre}"></div>
                        `;
                        
                        filesList.appendChild(genreGroup);
                        
                        const listContainer = document.getElementById(`list-${genre}`);
                        genreFiles.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            fileItem.innerHTML = `
                                <div class="file-info">
                                    <div class="file-title">${file.title}</div>
                                    <div class="file-details">${file.name} • ${this.formatFileSize(file.size)}</div>
                                </div>
                                <div class="file-artist">
                                    <input type="text" value="${file.artist}" 
                                           onchange="musicAdmin.updateArtist('${file.id}', this.value)"
                                           placeholder="Nombre del artista">
                                </div>
                                <button class="btn btn-danger btn-sm" 
                                        onclick="musicAdmin.removeFile('${file.id}')">🗑️</button>
                            `;
                            listContainer.appendChild(fileItem);
                        });
                    }
                });
            }

            updateArtist(fileId, newArtist) {
                const file = this.files.find(f => f.id === fileId);
                if (file) {
                    file.artist = newArtist;
                }
            }

            removeFile(fileId) {
                this.files = this.files.filter(f => f.id !== fileId);
                this.updateDisplay();
                this.showMessage('🗑️ Archivo eliminado', 'info');
            }

            applyBulkEdit() {
    const artistName = this.bulkArtistName.value.trim();
    const genre = this.bulkGenre.value;
    
    if (!artistName || !genre) {
        this.showMessage('⚠️ Completa todos los campos', 'error');
        return;
    }
    
    const updatedCount = this.files.filter(f => f.genre === genre).length;
    this.files.forEach(file => {
        if (file.genre === genre) {
            file.artist = artistName;
        }
    });
    
    this.renderFiles();
    this.showMessage(`✅ ${updatedCount} archivos actualizados con artista "${artistName}"`, 'success');
    
    this.bulkArtistName.value = '';
    this.bulkGenre.value = '';
}

            clearAll() {
                this.files = [];
                this.updateDisplay();
                this.codeOutput.style.display = 'none';
                this.showMessage('🗑️ Todos los archivos eliminados', 'info');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            generateCode() {
                if (this.files.length === 0) {
                    this.showMessage('⚠️ No hay archivos para generar código', 'error');
                    return;
                }

                const songs = this.files.map(fileData => {
                    const artistSlug = this.createSlug(fileData.artist);
                    const genreFolder = this.config.genres[fileData.genre].folder;
                    
                    return {
                        title: fileData.title,
                        artist: fileData.artist,
                        file: `mp3/${genreFolder}/${artistSlug}/${fileData.name}`,
                        genre: fileData.genre,
                        cover: `mp3/${genreFolder}/${artistSlug}/cover.jpg`,
                        duration: '0:00',
                        filename: fileData.name,
                        artistFolder: artistSlug
                    };
                });

                const code = this.createLoadSongsCode(songs);
                this.codeBlock.textContent = code;
                this.codeOutput.style.display = 'block';
                
                this.showMessage('📄 Código generado exitosamente', 'success');
            }

            createSlug(text) {
                return text
                    .toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '')
                    .replace(/_{2,}/g, '_')
                    .trim();
            }

            createLoadSongsCode(songs) {
                const songsJson = JSON.stringify(songs, null, 8);
                
                return `async loadSongs() {
    console.log('🎵 Cargando lista de canciones generada automáticamente...');
    this.showMessage('Cargando canciones...', 'info');
    
    // Lista generada automáticamente por Music Admin V2
    // Última actualización: ${new Date().toLocaleString('es-ES')}
    // Total de archivos: ${songs.length}
    // Estructura de carpetas: mp3/{género}/{artista}/archivo.mp3
    this.songs = ${songsJson};
    
    // Calcular estadísticas
    const stats = { 
        total: this.songs.length,
        coros: this.songs.filter(s => s.genre === 'coros').length,
        himnos: this.songs.filter(s => s.genre === 'himnos').length,
        testimoniales: this.songs.filter(s => s.genre === 'testimoniales').length,
        especiales: this.songs.filter(s => s.genre === 'especiales').length
    };
    
    this.showStats(stats);
    
    if (this.songs.length > 0) {
        this.showMessage(\`✅ \${this.songs.length} canciones cargadas exitosamente\`, 'success');
        console.log('📚 Canciones cargadas:', this.songs);
    } else {
        this.showMessage('⚠️ No se encontraron archivos MP3.', 'error');
    }
    
    this.filteredSongs = [...this.songs];
    this.renderPlaylist();
    
    if (this.songs.length > 0) {
        this.loadSong(0);
    }
    
    // Ocultar loading y mostrar contenido
    setTimeout(() => {
        this.loading.style.display = 'none';
        this.mainContent.style.display = 'block';
    }, 1000);
}`;
            }

            async downloadJSON() {
                if (this.files.length === 0) {
                    this.showMessage('⚠️ No hay datos para descargar', 'error');
                    return;
                }

                const songs = this.files.map(fileData => {
                    const artistSlug = this.createSlug(fileData.artist);
                    const genreFolder = this.config.genres[fileData.genre].folder;
                    
                    return {
                        title: fileData.title,
                        artist: fileData.artist,
                        file: `mp3/${genreFolder}/${artistSlug}/${fileData.name}`,
                        genre: fileData.genre,
                        cover: `mp3/${genreFolder}/${artistSlug}/cover.jpg`,
                        duration: '0:00',
                        filename: fileData.name,
                        artistFolder: artistSlug
                    };
                });

                const data = {
                    generatedAt: new Date().toISOString(),
                    totalFiles: this.files.length,
                    config: this.config,
                    songs: songs,
                    folderStructure: this.generateFolderStructure(songs)
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-admin-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('💾 Archivo JSON descargado', 'success');
            }

            generateFolderStructure(songs) {
                const structure = {};
                
                songs.forEach(song => {
                    const genre = song.genre;
                    const artist = song.artistFolder;
                    
                    if (!structure[genre]) {
                        structure[genre] = {};
                    }
                    
                    if (!structure[genre][artist]) {
                        structure[genre][artist] = {
                            files: [],
                            coverNeeded: true
                        };
                    }
                    
                    structure[genre][artist].files.push(song.filename);
                });
                
                return structure;
            }

            async copyList() {
                if (this.files.length === 0) {
                    this.showMessage('⚠️ No hay lista para copiar', 'error');
                    return;
                }

                const text = this.files.map(f => 
                    `${f.title} | ${f.artist} | ${f.genre} | ${f.name}`
                ).join('\n');
                
                try {
                    await navigator.clipboard.writeText(text);
                    this.showMessage('📋 Lista copiada al portapapeles', 'success');
                } catch (err) {
                    this.showMessage('❌ Error al copiar lista', 'error');
                }
            }

            async copyCode() {
                const codeBlock = document.getElementById('codeBlock');
                if (!codeBlock.textContent) {
                    this.showMessage('⚠️ Genera el código primero', 'error');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(codeBlock.textContent);
                    this.showMessage('📋 Código copiado al portapapeles', 'success');
                } catch (err) {
                    this.showMessage('❌ Error al copiar código', 'error');
                }
            }

            // Drag & Drop handlers
            handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                this.uploadArea.classList.add('drag-over');
            }

            handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                this.uploadArea.classList.remove('drag-over');
            }

            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                this.uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                this.handleFiles(files);
            }

            showMessage(text, type) {
                this.messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
                setTimeout(() => {
                    this.messageArea.innerHTML = '';
                }, 5000);
            }
        }

        // Funciones globales para acceso desde HTML
        let musicAdmin;

        function setBulkArtist(artistName) {
            if (musicAdmin && musicAdmin.bulkArtistName) {
                musicAdmin.bulkArtistName.value = artistName;
            }
        }

        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            musicAdmin = new MusicAdminV2();
        });
    </script>
</body>
</html>
