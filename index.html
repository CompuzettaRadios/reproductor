<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Alabanzas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
            font-size: 1.1em;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .search-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #searchInput {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        #searchInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .genre-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .filter-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .player-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .album-art {
            margin-bottom: 20px;
        }

        .album-art img {
            width: 150px;
            height: 150px;
            border-radius: 15px;
            object-fit: cover;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .album-art img:hover {
            transform: scale(1.05);
        }

        .player-info h3 {
            font-size: 1.4em;
            margin-bottom: 5px;
            color: #333;
        }

        .player-info p {
            color: #666;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-controls button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-controls button:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        #playBtn {
            width: 60px;
            height: 60px;
            font-size: 20px;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e1e5e9;
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #667eea;
            border-radius: 3px;
            transition: width 0.1s ease;
        }

        .progress-container span {
            font-size: 14px;
            color: #666;
            min-width: 35px;
        }

        .playlist-container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .playlist-container h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .playlist {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .song-item:hover {
            background: #f8f9fa;
            border-color: #e1e5e9;
            transform: translateX(5px);
        }

        .song-item.active {
            background: #667eea;
            color: white;
        }

        .song-item.active .song-genre {
            color: rgba(255,255,255,0.8);
        }

        .song-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .song-artist {
            font-size: 13px;
            color: #888;
            font-style: italic;
            margin-bottom: 2px;
        }

        .song-item.active .song-artist {
            color: rgba(255,255,255,0.9);
        }

        .song-duration {
            font-size: 14px;
            color: #999;
        }

        .no-songs {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-style: italic;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.9em;
        }

        .success-message {
            background: #efe;
            color: #090;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.9em;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            header h1 {
                font-size: 2em;
            }
            
            .genre-filters {
                justify-content: flex-start;
            }
            
            .filter-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .album-art img {
                width: 120px;
                height: 120px;
            }
            
            .player-controls {
                gap: 15px;
            }
            
            .player-controls button {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            #playBtn {
                width: 55px;
                height: 55px;
            }

            .stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎵 Mis Alabanzas</h1>
            <p>Coros, himnos y testimonios en alabanza</p>
        </header>

        <div id="loading" class="loading">
            Escaneando carpetas de música
        </div>

        <div id="mainContent" style="display: none;">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Buscar canción..." />
                <div class="genre-filters">
                    <button class="filter-btn active" data-genre="all">Todos</button>
                    <button class="filter-btn" data-genre="coros">Coros</button>
                    <button class="filter-btn" data-genre="himnos">Himnos</button>
                    <button class="filter-btn" data-genre="testimoniales">Testimoniales</button>
                    <button class="filter-btn" data-genre="especiales">Especiales</button>
                    <button class="refresh-btn" id="refreshBtn">🔄 Actualizar</button>
                </div>
            </div>

            <div class="player-container">
                <div class="album-art">
                    <img id="albumCover" src="" alt="Carátula">
                </div>
                <div class="player-info">
                    <h3 id="songTitle">Selecciona una canción</h3>
                    <p id="songGenre">-</p>
                </div>
                <div class="player-controls">
                    <button id="prevBtn">⏮</button>
                    <button id="playBtn">▶</button>
                    <button id="nextBtn">⏭</button>
                </div>
                <div class="progress-container">
                    <span id="currentTime">0:00</span>
                    <div class="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <span id="duration">0:00</span>
                </div>
                <audio id="audioPlayer"></audio>
            </div>

            <div class="playlist-container">
                <h2>Lista de Reproducción</h2>
                <div id="stats" class="stats"></div>
                <div id="messages"></div>
                <div id="playlist" class="playlist"></div>
            </div>
        </div>
    </div>

    <script>
        class MusicPlayer {
            constructor() {
                this.songs = [];
                this.filteredSongs = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.audio = document.getElementById('audioPlayer');
                
                // Configuración de carpetas de géneros
                this.genres = ['coros', 'himnos', 'testimoniales', 'especiales'];
                
                this.initializeElements();
                this.loadSongs();
                this.setupEventListeners();
            }

            initializeElements() {
                this.playBtn = document.getElementById('playBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.progress = document.getElementById('progress');
                this.progressBar = document.querySelector('.progress-bar');
                this.currentTime = document.getElementById('currentTime');
                this.duration = document.getElementById('duration');
                this.songTitle = document.getElementById('songTitle');
                this.songGenre = document.getElementById('songGenre');
                this.albumCover = document.getElementById('albumCover');
                this.playlist = document.getElementById('playlist');
                this.searchInput = document.getElementById('searchInput');
                this.filterBtns = document.querySelectorAll('.filter-btn');
                this.refreshBtn = document.getElementById('refreshBtn');
                this.loading = document.getElementById('loading');
                this.mainContent = document.getElementById('mainContent');
                this.stats = document.getElementById('stats');
                this.messages = document.getElementById('messages');
            }

            async loadSongs() {
                console.log('🎵 Iniciando escaneo automático de carpetas...');
                this.showMessage('Escaneando carpetas de música...', 'info');
                
                this.songs = [];
                const stats = { total: 0, coros: 0, himnos: 0, testimoniales: 0, especiales: 0 };
                
                // Escanear cada género
                for (const genre of this.genres) {
                    try {
                        const genreSongs = await this.scanGenreFolder(genre);
                        this.songs.push(...genreSongs);
                        stats[genre] = genreSongs.length;
                        stats.total += genreSongs.length;
                        console.log(`📁 ${genre}: ${genreSongs.length} archivos encontrados`);
                    } catch (error) {
                        console.warn(`⚠️ Error escaneando ${genre}:`, error.message);
                    }
                }
                
                // Mostrar estadísticas
                this.showStats(stats);
                
                if (this.songs.length > 0) {
                    this.showMessage(`✅ ${this.songs.length} canciones cargadas exitosamente`, 'success');
                    console.log('📚 Todas las canciones:', this.songs);
                } else {
                    this.showMessage('⚠️ No se encontraron archivos MP3. Asegúrate de tener archivos en las carpetas mp3/', 'error');
                }
                
                this.filteredSongs = [...this.songs];
                this.renderPlaylist();
                
                if (this.songs.length > 0) {
                    this.loadSong(0);
                }
                
                // Ocultar loading y mostrar contenido
                setTimeout(() => {
                    this.loading.style.display = 'none';
                    this.mainContent.style.display = 'block';
                }, 1000);
            }

            async scanGenreFolder(genre) {
                const songs = [];
                const folderPath = `mp3/${genre}/`;
                
                try {
                    // Intentar obtener el listado de la carpeta
                    const response = await fetch(folderPath);
                    
                    if (!response.ok) {
                        throw new Error(`Carpeta ${folderPath} no accesible (${response.status})`);
                    }
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Buscar enlaces a archivos MP3
                    const links = doc.querySelectorAll('a[href$=".mp3"], a[href$=".MP3"]');
                    
                    console.log(`🔍 Encontrados ${links.length} archivos MP3 en ${genre}`);
                    
                    for (const link of links) {
                        const filename = link.getAttribute('href');
                        if (filename && !filename.startsWith('../') && !filename.startsWith('/')) {
                            const song = this.createSongFromFile(filename, genre);
                            songs.push(song);
                        }
                    }
                    
                    // Si no hay archivos, intentar con algunos nombres comunes
                    if (songs.length === 0) {
                        console.log(`📝 Intentando detectar archivos comunes en ${genre}...`);
                        const commonFiles = await this.tryCommonFiles(genre);
                        songs.push(...commonFiles);
                    }
                    
                } catch (error) {
                    console.warn(`❌ No se pudo acceder a la carpeta ${folderPath}:`, error.message);
                    
                    // Fallback: intentar algunos archivos comunes
                    const fallbackFiles = await this.tryCommonFiles(genre);
                    songs.push(...fallbackFiles);
                }
                
                return songs;
            }

            async tryCommonFiles(genre) {
                const songs = [];
                const commonNames = [
                    'track1.mp3', 'track2.mp3', 'track3.mp3',
                    'song1.mp3', 'song2.mp3', 'song3.mp3',
                    'audio1.mp3', 'audio2.mp3', 'audio3.mp3',
                    `${genre}1.mp3`, `${genre}2.mp3`, `${genre}3.mp3`
                ];
                
                for (const filename of commonNames) {
                    try {
                        const testUrl = `mp3/${genre}/${filename}`;
                        const response = await fetch(testUrl, { method: 'HEAD' });
                        if (response.ok) {
                            const song = this.createSongFromFile(filename, genre);
                            songs.push(song);
                            console.log(`✅ Archivo encontrado: ${testUrl}`);
                        }
                    } catch (error) {
                        // Silently ignore errors for test files
                    }
                }
                
                return songs;
            }

            createSongFromFile(filename, genre) {
                // Limpiar y formatear el nombre del archivo como título
                const title = this.formatSongTitle(filename);
                
                return {
                    title: title,
                    artist: this.guessArtistFromGenre(genre),
                    file: `mp3/${genre}/${filename}`,
                    genre: genre,
                    cover: `mp3/${genre}/cover.jpg`,
                    duration: '0:00',
                    filename: filename
                };
            }

            formatSongTitle(filename) {
                return filename
                    .replace(/\.(mp3|MP3)$/, '') // Quitar extensión
                    .replace(/[-_]/g, ' ') // Reemplazar guiones y guiones bajos
                    .replace(/\b\w/g, l => l.toUpperCase()) // Capitalizar primeras letras
                    .trim();
            }

            guessArtistFromGenre(genre) {
                const artistMap = {
                    'coros': 'Congregación',
                    'himnos': 'Himno Tradicional',
                    'testimoniales': 'Testimonio',
                    'especiales': 'Alabanza Especial'
                };
                return artistMap[genre] || 'Desconocido';
            }

            showStats(stats) {
                const statText = [
                    `Total: ${stats.total}`,
                    `Coros: ${stats.coros}`,
                    `Himnos: ${stats.himnos}`,
                    `Testimoniales: ${stats.testimoniales}`,
                    `Especiales: ${stats.especiales}`
                ];
                this.stats.innerHTML = statText.join(' • ');
            }

            showMessage(text, type = 'info') {
                const messageClass = type === 'error' ? 'error-message' : 
                                   type === 'success' ? 'success-message' : 
                                   'info-message';
                
                this.messages.innerHTML = `<div class="${messageClass}">${text}</div>`;
                
                // Auto-hide success/info messages after 5 seconds
                if (type !== 'error') {
                    setTimeout(() => {
                        this.messages.innerHTML = '';
                    }, 5000);
                }
            }

            setupEventListeners() {
                // Controles del reproductor
                this.playBtn.addEventListener('click', () => this.togglePlay());
                this.prevBtn.addEventListener('click', () => this.previousSong());
                this.nextBtn.addEventListener('click', () => this.nextSong());

                // Botón refresh
                this.refreshBtn.addEventListener('click', () => this.refreshSongs());

                // Barra de progreso
                this.progressBar.addEventListener('click', (e) => this.setProgress(e));

                // Audio eventos
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.nextSong());
                this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                this.audio.addEventListener('error', (e) => this.handleAudioError(e));

                // Búsqueda
                this.searchInput.addEventListener('input', (e) => this.filterSongs(e.target.value));

                // Filtros de género
                this.filterBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => this.filterByGenre(e.target.dataset.genre));
                });
            }

            async refreshSongs() {
                this.showMessage('Actualizando lista de canciones...', 'info');
                this.refreshBtn.disabled = true;
                this.refreshBtn.textContent = '🔄 Actualizando...';
                
                await this.loadSongs();
                
                this.refreshBtn.disabled = false;
                this.refreshBtn.textContent = '🔄 Actualizar';
            }

            handleAudioError(e) {
                console.error('Error al cargar audio:', e);
                this.showMessage(`Error al cargar: ${this.filteredSongs[this.currentIndex]?.title || 'archivo'}`, 'error');
            }

            loadSong(index) {
                if (index < 0 || index >= this.filteredSongs.length) return;
                
                this.currentIndex = index;
                const song = this.filteredSongs[index];
                
                console.log('🎵 Cargando canción:', song);
                
                this.audio.src = song.file;
                this.songTitle.textContent = song.title;
                
                // Mostrar artista si existe
                const genreText = song.artist && song.artist !== 'Desconocido' 
                    ? `${song.artist} • ${song.genre.charAt(0).toUpperCase() + song.genre.slice(1)}`
                    : song.genre.charAt(0).toUpperCase() + song.genre.slice(1);
                    
                this.songGenre.textContent = genreText;
                
                // Cargar imagen de carátula
                this.loadAlbumCover(song.cover);
                
                this.updateActiveItem();
            }

            loadAlbumCover(coverPath) {
                const img = new Image();
                img.onload = () => {
                    this.albumCover.src = coverPath;
                };
                img.onerror = () => {
                    this.albumCover.src = this.createDefaultCover();
                };
                img.src = coverPath;
            }

            createDefaultCover() {
                const svg = `data:image/svg+xml,${encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150">
                        <defs>
                            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="150" height="150" fill="url(#grad)"/>
                        <text x="75" y="70" text-anchor="middle" font-family="Arial" font-size="20" fill="white">🎵</text>
                        <text x="75" y="90" text-anchor="middle" font-family="Arial" font-size="12" fill="white">Alabanza</text>
                    </svg>
                `)}`;
                return svg;
            }

            togglePlay() {
                if (this.filteredSongs.length === 0) return;
                
                if (this.isPlaying) {
                    this.audio.pause();
                    this.playBtn.textContent = '▶';
                    this.isPlaying = false;
                } else {
                    const playPromise = this.audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            this.playBtn.textContent = '⏸';
                            this.isPlaying = true;
                        }).catch(error => {
                            console.error('Error al reproducir:', error);
                            this.handleAudioError(error);
                        });
                    }
                }
            }

            previousSong() {
                if (this.filteredSongs.length === 0) return;
                const newIndex = this.currentIndex > 0 ? this.currentIndex - 1 : this.filteredSongs.length - 1;
                this.loadSong(newIndex);
                if (this.isPlaying) {
                    this.audio.play();
                }
            }

            nextSong() {
                if (this.filteredSongs.length === 0) return;
                const newIndex = this.currentIndex < this.filteredSongs.length - 1 ? this.currentIndex + 1 : 0;
                this.loadSong(newIndex);
                if (this.isPlaying) {
                    this.audio.play();
                }
            }

            updateProgress() {
                const { currentTime, duration } = this.audio;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    this.progress.style.width = `${progressPercent}%`;
                }
                
                this.currentTime.textContent = this.formatTime(currentTime);
            }

            updateDuration() {
                this.duration.textContent = this.formatTime(this.audio.duration);
            }

            setProgress(e) {
                const clickX = e.offsetX;
                const width = this.progressBar.offsetWidth;
                const duration = this.audio.duration;
                
                if (duration) {
                    this.audio.currentTime = (clickX / width) * duration;
                }
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            renderPlaylist() {
                this.playlist.innerHTML = '';
                
                if (this.filteredSongs.length === 0) {
                    this.playlist.innerHTML = '<div class="no-songs">No se encontraron canciones.<br>Sube archivos MP3 a las carpetas correspondientes y presiona "Actualizar".</div>';
                    return;
                }
                
                this.filteredSongs.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = 'song-item';
                    
                    const artistInfo = song.artist && song.artist !== 'Desconocido' 
                        ? `<div class="song-artist">${song.artist}</div>` 
                        : '';
                    
                    songItem.innerHTML = `
                        <img src="${song.cover}" alt="${song.title}" class="song-cover" 
                             onerror="this.src='${this.createDefaultCover()}'">
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            ${artistInfo}
                            <div class="song-genre">${song.genre}</div>
                        </div>
                        <div class="song-duration">${song.duration}</div>
                    `;
                    
                    songItem.addEventListener('click', () => {
                        this.loadSong(index);
                        if (!this.isPlaying) {
                            this.togglePlay();
                        }
                    });
                    
                    this.playlist.appendChild(songItem);
                });

                this.updateActiveItem();
            }

            updateActiveItem() {
                const items = this.playlist.querySelectorAll('.song-item');
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === this.currentIndex);
                });
            }

            filterSongs(searchTerm) {
                const filtered = this.songs.filter(song => 
                    song.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    song.genre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (song.artist && song.artist.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                
                this.filteredSongs = filtered;
                this.currentIndex = 0;
                this.renderPlaylist();
                
                if (this.filteredSongs.length > 0) {
                    this.loadSong(0);
                }
            }

filterByGenre(genre) {
                // Actualizar botones activos
                this.filterBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.genre === genre);
                });

                if (genre === 'all') {
                    this.filteredSongs = [...this.songs];
                } else {
                    this.filteredSongs = this.songs.filter(song => song.genre === genre);
                }
                
                this.currentIndex = 0;
                this.renderPlaylist();
                
                if (this.filteredSongs.length > 0) {
                    this.loadSong(0);
                } else {
                    this.songTitle.textContent = 'No hay canciones en esta categoría';
                    this.songGenre.textContent = '-';
                    this.albumCover.src = this.createDefaultCover();
                }
            }

            // Método para obtener duración real del archivo
            async updateSongDuration(song, index) {
                return new Promise((resolve) => {
                    const tempAudio = new Audio();
                    tempAudio.addEventListener('loadedmetadata', () => {
                        const duration = this.formatTime(tempAudio.duration);
                        song.duration = duration;
                        
                        // Actualizar en la lista si está visible
                        const durationElements = document.querySelectorAll('.song-duration');
                        if (durationElements[index]) {
                            durationElements[index].textContent = duration;
                        }
                        
                        resolve(duration);
                    });
                    
                    tempAudio.addEventListener('error', () => {
                        song.duration = 'Error';
                        resolve('Error');
                    });
                    
                    tempAudio.src = song.file;
                });
            }

            // Cargar duraciones de todas las canciones (opcional, para mejor UX)
            async loadAllDurations() {
                console.log('🕐 Cargando duraciones de archivos...');
                
                for (let i = 0; i < this.songs.length; i++) {
                    const song = this.songs[i];
                    if (song.duration === '0:00') {
                        await this.updateSongDuration(song, i);
                        
                        // Pequeña pausa para no sobrecargar
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                console.log('✅ Duraciones cargadas');
                this.renderPlaylist(); // Re-renderizar con duraciones actualizadas
            }

            // Método para detectar si hay nuevos archivos
            async checkForNewFiles() {
                const currentCount = this.songs.length;
                await this.loadSongs();
                const newCount = this.songs.length;
                
                if (newCount > currentCount) {
                    this.showMessage(`🎉 Se encontraron ${newCount - currentCount} nuevas canciones`, 'success');
                } else if (newCount < currentCount) {
                    this.showMessage(`📝 Se actualizó la lista (${newCount} canciones total)`, 'info');
                } else {
                    this.showMessage('✅ La lista está actualizada', 'success');
                }
            }

            // Método para manejar atajos de teclado
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Solo funcionar si no estamos escribiendo en el input de búsqueda
                    if (e.target === this.searchInput) return;
                    
                    switch(e.code) {
                        case 'Space':
                            e.preventDefault();
                            this.togglePlay();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.previousSong();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.nextSong();
                            break;
                        case 'KeyR':
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                this.refreshSongs();
                            }
                            break;
                    }
                });
            }

            // Inicializar todo
            init() {
                this.setupKeyboardShortcuts();
                
                // Cargar duraciones después de que se carguen las canciones
                setTimeout(() => {
                    if (this.songs.length > 0) {
                        this.loadAllDurations();
                    }
                }, 2000);
            }
        }

        // Inicializar el reproductor cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            const player = new MusicPlayer();
            player.init();
            
            // Auto-refresh cada 5 minutos para detectar nuevos archivos
            setInterval(() => {
                console.log('🔄 Verificación automática de nuevos archivos...');
                player.checkForNewFiles();
            }, 300000); // 5 minutos
        });
    </script>
</body>
</html>
